name: Create Repository with Approval

on:
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'Repository name'
        required: true
        type: string
      repo_description:
        description: 'Repository description'
        required: false
        type: string
      port_context:
        description: 'Port context'
        required: true
        type: string

jobs:
  request-approval:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.result }}
    steps:
      - name: Create Approval Issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Approve: Create repository "${{ github.event.inputs.repository_name }}"`,
              body: `### Repository Creation Request
              
            **Name:** \`${{ github.event.inputs.repository_name }}\`
            **Description:** ${{ github.event.inputs.repo_description }}
            **Requested by:** @${{ github.actor }}
            
            ---
            
            **To approve:** Comment \`/approve\`
            **To deny:** Comment \`/deny\``,
              labels: ['approval-required']
            });
            
            console.log('Created approval issue:', issue.data.number);
            return issue.data.number;

      - name: Wait for Approval
        uses: actions/github-script@v7
        timeout-minutes: 60
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            
            while (true) {
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              for (const comment of comments.data) {
                const body = comment.body.trim().toLowerCase();
                
                if (body === '/approve') {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: '‚úÖ **Approved** - Creating repository...'
                  });
                  
                  return true;
                }
                
                if (body === '/deny') {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: '‚ùå **Denied** - Request cancelled'
                  });
                  
                  throw new Error('Request denied');
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, 10000));
            }

  create-repository:
    runs-on: ubuntu-latest
    needs: request-approval
    if: success()
    steps:
      - name: Create Repository
        id: create-repo
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repoName = '${{ github.event.inputs.repository_name }}';
            const repoDesc = '${{ github.event.inputs.repo_description }}';
            
            const owner = await github.rest.users.getByUsername({
              username: context.repo.owner
            });
            
            let repo;
            
            if (owner.data.type === 'Organization') {
              repo = await github.rest.repos.createInOrg({
                org: context.repo.owner,
                name: repoName,
                description: repoDesc,
                private: false,
                auto_init: true
              });
            } else {
              repo = await github.rest.repos.createForAuthenticatedUser({
                name: repoName,
                description: repoDesc,
                private: false,
                auto_init: true
              });
            }
            
            console.log('‚úÖ Repository created:', repo.data.html_url);
            core.setOutput('repo_url', repo.data.html_url);
            return repo.data.html_url;

      - name: Update Port Entity
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: UPSERT
          identifier: ${{ github.event.inputs.repository_name }}
          title: ${{ github.event.inputs.repository_name }}
          blueprint: githubRepository
          properties: |
            {
              "url": "${{ steps.create-repo.outputs.repo_url }}",
              "description": "${{ github.event.inputs.repo_description }}"
            }

      - name: Notify Port - Success
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          logMessage: |
            ‚úÖ Repository created successfully!
            üîó ${{ steps.create-repo.outputs.repo_url }}

      - name: Notify Port - Failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          operation: PATCH_RUN
          runId: ${{ fromJson(github.event.inputs.port_context).runId }}
          logMessage: |
            ‚ùå Failed to create repository